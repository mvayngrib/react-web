








'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();

var _ReactNavigationEvent=require('./NavigationEvent');var _ReactNavigationEvent2=_interopRequireDefault(_ReactNavigationEvent);
var _ReactNavigationEventEmitter=require('./NavigationEventEmitter');var _ReactNavigationEventEmitter2=_interopRequireDefault(_ReactNavigationEventEmitter);
var _ReactNavigationTreeNode=require('./NavigationTreeNode');var _ReactNavigationTreeNode2=_interopRequireDefault(_ReactNavigationTreeNode);
var _emptyFunction=require('fbjs/lib/emptyFunction');var _emptyFunction2=_interopRequireDefault(_emptyFunction);
var _invariant=require('fbjs/lib/invariant');var _invariant2=_interopRequireDefault(_invariant);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var




AT_TARGET=_ReactNavigationEvent2.default.AT_TARGET;var
BUBBLING_PHASE=_ReactNavigationEvent2.default.BUBBLING_PHASE;var
CAPTURING_PHASE=_ReactNavigationEvent2.default.CAPTURING_PHASE;var





NavigationContext=function(){







function NavigationContext(){_classCallCheck(this,NavigationContext);
this._bubbleEventEmitter=new _ReactNavigationEventEmitter2.default(this);
this._captureEventEmitter=new _ReactNavigationEventEmitter2.default(this);
this._currentRoute=null;


this.__node=new _ReactNavigationTreeNode2.default(this);

this._emitCounter=0;
this._emitQueue=[];

this.addListener('willfocus',this._onFocus,this);
this.addListener('didfocus',this._onFocus,this);
}_createClass(NavigationContext,[{key:'appendChild',value:function appendChild(












childContext){
this.__node.appendChild(childContext.__node);
}},{key:'addListener',value:function addListener(


eventType,
listener,
context,
useCapture)
{
var emitter=useCapture?
this._captureEventEmitter:
this._bubbleEventEmitter;
if(emitter){
return emitter.addListener(eventType,listener,context);
}else{
return{remove:_emptyFunction2.default};
}
}},{key:'emit',value:function emit(

eventType,data,didEmitCallback){var _this=this;
if(this._emitCounter>0){


var args=Array.prototype.slice.call(arguments);
this._emitQueue.push(args);
return;
}

this._emitCounter++;

var targets=[this];
var parentTarget=this.parent;
while(parentTarget){
targets.unshift(parentTarget);
parentTarget=parentTarget.parent;
}

var propagationStopped=false;
var defaultPrevented=false;
var callback=function callback(event){
propagationStopped=propagationStopped||event.isPropagationStopped();
defaultPrevented=defaultPrevented||event.defaultPrevented;
};


targets.some(function(currentTarget){
if(propagationStopped){
return true;
}

var extraInfo={
defaultPrevented:defaultPrevented,
eventPhase:CAPTURING_PHASE,
propagationStopped:propagationStopped,
target:_this};


currentTarget.__emit(eventType,data,callback,extraInfo);
},this);


targets.reverse().some(function(currentTarget){
if(propagationStopped){
return true;
}
var extraInfo={
defaultPrevented:defaultPrevented,
eventPhase:BUBBLING_PHASE,
propagationStopped:propagationStopped,
target:_this};

currentTarget.__emit(eventType,data,callback,extraInfo);
},this);

if(didEmitCallback){
var event=_ReactNavigationEvent2.default.pool(eventType,this,data);
propagationStopped&&event.stopPropagation();
defaultPrevented&&event.preventDefault();
didEmitCallback.call(this,event);
event.dispose();
}

this._emitCounter--;
while(this._emitQueue.length){
var args=this._emitQueue.shift();
this.emit.apply(this,args);
}
}},{key:'dispose',value:function dispose()

{

this._bubbleEventEmitter&&this._bubbleEventEmitter.removeAllListeners();
this._captureEventEmitter&&this._captureEventEmitter.removeAllListeners();
this._bubbleEventEmitter=null;
this._captureEventEmitter=null;
this._currentRoute=null;
}},{key:'__emit',value:function __emit(



eventType,
data,
didEmitCallback,
extraInfo)
{
var emitter;
switch(extraInfo.eventPhase){
case CAPTURING_PHASE:
emitter=this._captureEventEmitter;
break;
case BUBBLING_PHASE:
emitter=this._bubbleEventEmitter;
break;
default:
(0,_invariant2.default)(false,'invalid event phase %s',extraInfo.eventPhase);}


if(extraInfo.target===this){

extraInfo.eventPhase=AT_TARGET;
}

if(emitter){
emitter.emit(
eventType,
data,
didEmitCallback,
extraInfo);

}
}},{key:'_onFocus',value:function _onFocus(

event){
(0,_invariant2.default)(
event.data&&event.data.hasOwnProperty('route'),
'didfocus event should provide route');

this._currentRoute=event.data.route;
}},{key:'parent',get:function get(){var parent=this.__node.getParent();return parent?parent.getValue():null;}},{key:'currentRoute',get:function get(){return this._currentRoute;}}]);return NavigationContext;}();


module.exports=NavigationContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIk5hdmlnYXRpb25Db250ZXh0LmpzIl0sIm5hbWVzIjpbIkFUX1RBUkdFVCIsIkJVQkJMSU5HX1BIQVNFIiwiQ0FQVFVSSU5HX1BIQVNFIiwiTmF2aWdhdGlvbkNvbnRleHQiLCJfYnViYmxlRXZlbnRFbWl0dGVyIiwiX2NhcHR1cmVFdmVudEVtaXR0ZXIiLCJfY3VycmVudFJvdXRlIiwiX19ub2RlIiwiX2VtaXRDb3VudGVyIiwiX2VtaXRRdWV1ZSIsImFkZExpc3RlbmVyIiwiX29uRm9jdXMiLCJjaGlsZENvbnRleHQiLCJhcHBlbmRDaGlsZCIsImV2ZW50VHlwZSIsImxpc3RlbmVyIiwiY29udGV4dCIsInVzZUNhcHR1cmUiLCJlbWl0dGVyIiwicmVtb3ZlIiwiZGF0YSIsImRpZEVtaXRDYWxsYmFjayIsImFyZ3MiLCJBcnJheSIsInByb3RvdHlwZSIsInNsaWNlIiwiY2FsbCIsImFyZ3VtZW50cyIsInB1c2giLCJ0YXJnZXRzIiwicGFyZW50VGFyZ2V0IiwicGFyZW50IiwidW5zaGlmdCIsInByb3BhZ2F0aW9uU3RvcHBlZCIsImRlZmF1bHRQcmV2ZW50ZWQiLCJjYWxsYmFjayIsImV2ZW50IiwiaXNQcm9wYWdhdGlvblN0b3BwZWQiLCJzb21lIiwiY3VycmVudFRhcmdldCIsImV4dHJhSW5mbyIsImV2ZW50UGhhc2UiLCJ0YXJnZXQiLCJfX2VtaXQiLCJyZXZlcnNlIiwicG9vbCIsInN0b3BQcm9wYWdhdGlvbiIsInByZXZlbnREZWZhdWx0IiwiZGlzcG9zZSIsImxlbmd0aCIsInNoaWZ0IiwiZW1pdCIsImFwcGx5IiwicmVtb3ZlQWxsTGlzdGVuZXJzIiwiaGFzT3duUHJvcGVydHkiLCJyb3V0ZSIsImdldFBhcmVudCIsImdldFZhbHVlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBU0EsYTs7QUFFQSx1RDtBQUNBLHFFO0FBQ0EsNkQ7QUFDQSxxRDtBQUNBLDZDOzs7OztBQUtFQSxTLGdDQUFBQSxTO0FBQ0FDLGMs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QUVELEdBQUlrQixPQUFKLENBQWE7QUFDWEEsUUFBUWlDLElBQVI7QUFDRXJDLFNBREY7QUFFRU0sSUFGRjtBQUdFQyxlQUhGO0FBSUVtQixTQUpGOztBQU1EO0FBQ0YsQzs7QUFFUUosSyxDQUE4QjtBQUNyQztBQUNFQSxNQUFNaEIsSUFBTixFQUFjZ0IsTUFBTWhCLElBQU4sQ0FBV2tDLGNBQVgsQ0FBMEIsT0FBMUIsQ0FEaEI7QUFFRSxxQ0FGRjs7QUFJQSxLQUFLaEQsYUFBTCxDQUFxQjhCLE1BQU1oQixJQUFOLENBQVdtQyxLQUFoQztBQUNELEMsa0NBckpnQyxDQUMvQixHQUFJeEIsUUFBUyxLQUFLeEIsTUFBTCxDQUFZaUQsU0FBWixFQUFiLENBQ0EsTUFBT3pCLFFBQVNBLE9BQU8wQixRQUFQLEVBQVQsQ0FBNkIsSUFBcEMsQ0FDRCxDLHdDQUd1QixDQUN0QixNQUFPLE1BQUtuRCxhQUFaLENBQ0QsQzs7O0FBZ0pIb0QsT0FBT0MsT0FBUCxDQUFpQnhELGlCQUFqQiIsImZpbGUiOiJOYXZpZ2F0aW9uQ29udGV4dC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEFsaWJhYmEgR3JvdXAgSG9sZGluZyBMaW1pdGVkLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogQHByb3ZpZGVzTW9kdWxlIFJlYWN0TmF2aWdhdGlvbkNvbnRleHRcbiAqL1xuJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgTmF2aWdhdGlvbkV2ZW50IGZyb20gJ1JlYWN0TmF2aWdhdGlvbkV2ZW50JztcbmltcG9ydCBOYXZpZ2F0aW9uRXZlbnRFbWl0dGVyIGZyb20gJ1JlYWN0TmF2aWdhdGlvbkV2ZW50RW1pdHRlcic7XG5pbXBvcnQgTmF2aWdhdGlvblRyZWVOb2RlIGZyb20gJ1JlYWN0TmF2aWdhdGlvblRyZWVOb2RlJztcbmltcG9ydCBlbXB0eUZ1bmN0aW9uIGZyb20gJ2ZianMvbGliL2VtcHR5RnVuY3Rpb24nO1xuaW1wb3J0IGludmFyaWFudCBmcm9tICdmYmpzL2xpYi9pbnZhcmlhbnQnO1xuXG5pbXBvcnQgdHlwZSAqIGFzIEV2ZW50U3Vic2NyaXB0aW9uIGZyb20gJ0V2ZW50U3Vic2NyaXB0aW9uJztcblxudmFyIHtcbiAgQVRfVEFSR0VULFxuICBCVUJCTElOR19QSEFTRSxcbiAgQ0FQVFVSSU5HX1BIQVNFLFxufSA9IE5hdmlnYXRpb25FdmVudDtcblxuLyoqXG4gKiBDbGFzcyB0aGF0IGNvbnRhaW5zIHRoZSBpbmZvIGFuZCBtZXRob2RzIGZvciBhcHAgbmF2aWdhdGlvbi5cbiAqL1xuY2xhc3MgTmF2aWdhdGlvbkNvbnRleHQge1xuICBfX25vZGU6IE5hdmlnYXRpb25UcmVlTm9kZTtcbiAgX2J1YmJsZUV2ZW50RW1pdHRlcjogP05hdmlnYXRpb25FdmVudEVtaXR0ZXI7XG4gIF9jYXB0dXJlRXZlbnRFbWl0dGVyOiA/TmF2aWdhdGlvbkV2ZW50RW1pdHRlcjtcbiAgX2N1cnJlbnRSb3V0ZTogYW55O1xuICBfZW1pdENvdW50ZXI6IG51bWJlcjtcbiAgX2VtaXRRdWV1ZTogQXJyYXk8YW55PjtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLl9idWJibGVFdmVudEVtaXR0ZXIgPSBuZXcgTmF2aWdhdGlvbkV2ZW50RW1pdHRlcih0aGlzKTtcbiAgICB0aGlzLl9jYXB0dXJlRXZlbnRFbWl0dGVyID0gbmV3IE5hdmlnYXRpb25FdmVudEVtaXR0ZXIodGhpcyk7XG4gICAgdGhpcy5fY3VycmVudFJvdXRlID0gbnVsbDtcblxuICAgIC8vIFNldHMgdGhlIHByb3RlY3RlZCBwcm9wZXJ0eSBgX19ub2RlYC5cbiAgICB0aGlzLl9fbm9kZSA9IG5ldyBOYXZpZ2F0aW9uVHJlZU5vZGUodGhpcyk7XG5cbiAgICB0aGlzLl9lbWl0Q291bnRlciA9IDA7XG4gICAgdGhpcy5fZW1pdFF1ZXVlID0gW107XG5cbiAgICB0aGlzLmFkZExpc3RlbmVyKCd3aWxsZm9jdXMnLCB0aGlzLl9vbkZvY3VzLCB0aGlzKTtcbiAgICB0aGlzLmFkZExpc3RlbmVyKCdkaWRmb2N1cycsIHRoaXMuX29uRm9jdXMsIHRoaXMpO1xuICB9XG5cbiAgLyogJEZsb3dGaXhNZSAtIGdldC9zZXQgcHJvcGVydGllcyBub3QgeWV0IHN1cHBvcnRlZCAqL1xuICBnZXQgcGFyZW50KCk6ID9OYXZpZ2F0aW9uQ29udGV4dCB7XG4gICAgdmFyIHBhcmVudCA9IHRoaXMuX19ub2RlLmdldFBhcmVudCgpO1xuICAgIHJldHVybiBwYXJlbnQgPyBwYXJlbnQuZ2V0VmFsdWUoKSA6IG51bGw7XG4gIH1cblxuICAvKiAkRmxvd0ZpeE1lIC0gZ2V0L3NldCBwcm9wZXJ0aWVzIG5vdCB5ZXQgc3VwcG9ydGVkICovXG4gIGdldCBjdXJyZW50Um91dGUoKTogYW55IHtcbiAgICByZXR1cm4gdGhpcy5fY3VycmVudFJvdXRlO1xuICB9XG5cbiAgYXBwZW5kQ2hpbGQoY2hpbGRDb250ZXh0OiBOYXZpZ2F0aW9uQ29udGV4dCk6IHZvaWQge1xuICAgIHRoaXMuX19ub2RlLmFwcGVuZENoaWxkKGNoaWxkQ29udGV4dC5fX25vZGUpO1xuICB9XG5cbiAgYWRkTGlzdGVuZXIoXG4gICAgZXZlbnRUeXBlOiBzdHJpbmcsXG4gICAgbGlzdGVuZXI6IEZ1bmN0aW9uLFxuICAgIGNvbnRleHQ6ID9PYmplY3QsXG4gICAgdXNlQ2FwdHVyZTogP2Jvb2xlYW5cbiAgKTogRXZlbnRTdWJzY3JpcHRpb24ge1xuICAgIHZhciBlbWl0dGVyID0gdXNlQ2FwdHVyZSA/XG4gICAgICB0aGlzLl9jYXB0dXJlRXZlbnRFbWl0dGVyIDpcbiAgICAgIHRoaXMuX2J1YmJsZUV2ZW50RW1pdHRlcjtcbiAgICBpZiAoZW1pdHRlcikge1xuICAgICAgcmV0dXJuIGVtaXR0ZXIuYWRkTGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lciwgY29udGV4dCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB7cmVtb3ZlOiBlbXB0eUZ1bmN0aW9ufTtcbiAgICB9XG4gIH1cblxuICBlbWl0KGV2ZW50VHlwZTogU3RyaW5nLCBkYXRhOiBhbnksIGRpZEVtaXRDYWxsYmFjazogP0Z1bmN0aW9uKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX2VtaXRDb3VudGVyID4gMCkge1xuICAgICAgLy8gQW4gZXZlbnQgY3ljbGUgdGhhdCB3YXMgcHJldmlvdXNseSBjcmVhdGVkIGhhc24ndCBmaW5pc2hlZCB5ZXQuXG4gICAgICAvLyBQdXQgdGhpcyBldmVudCBjeWNsZSBpbnRvIHRoZSBxdWV1ZSBhbmQgd2lsbCBmaW5pc2ggdGhlbSBsYXRlci5cbiAgICAgIHZhciBhcmdzOiBhbnkgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpO1xuICAgICAgdGhpcy5fZW1pdFF1ZXVlLnB1c2goYXJncyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5fZW1pdENvdW50ZXIrKztcblxuICAgIHZhciB0YXJnZXRzID0gW3RoaXNdO1xuICAgIHZhciBwYXJlbnRUYXJnZXQgPSB0aGlzLnBhcmVudDtcbiAgICB3aGlsZSAocGFyZW50VGFyZ2V0KSB7XG4gICAgICB0YXJnZXRzLnVuc2hpZnQocGFyZW50VGFyZ2V0KTtcbiAgICAgIHBhcmVudFRhcmdldCA9IHBhcmVudFRhcmdldC5wYXJlbnQ7XG4gICAgfVxuXG4gICAgdmFyIHByb3BhZ2F0aW9uU3RvcHBlZCA9IGZhbHNlO1xuICAgIHZhciBkZWZhdWx0UHJldmVudGVkID0gZmFsc2U7XG4gICAgdmFyIGNhbGxiYWNrID0gKGV2ZW50KSA9PiB7XG4gICAgICBwcm9wYWdhdGlvblN0b3BwZWQgPSBwcm9wYWdhdGlvblN0b3BwZWQgfHwgZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKTtcbiAgICAgIGRlZmF1bHRQcmV2ZW50ZWQgPSBkZWZhdWx0UHJldmVudGVkIHx8IGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQ7XG4gICAgfTtcblxuICAgIC8vIGNhcHR1cmUgcGhhc2VcbiAgICB0YXJnZXRzLnNvbWUoKGN1cnJlbnRUYXJnZXQpID0+IHtcbiAgICAgIGlmIChwcm9wYWdhdGlvblN0b3BwZWQpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG5cbiAgICAgIHZhciBleHRyYUluZm8gPSB7XG4gICAgICAgIGRlZmF1bHRQcmV2ZW50ZWQsXG4gICAgICAgIGV2ZW50UGhhc2U6IENBUFRVUklOR19QSEFTRSxcbiAgICAgICAgcHJvcGFnYXRpb25TdG9wcGVkLFxuICAgICAgICB0YXJnZXQ6IHRoaXMsXG4gICAgICB9O1xuXG4gICAgICBjdXJyZW50VGFyZ2V0Ll9fZW1pdChldmVudFR5cGUsIGRhdGEsIGNhbGxiYWNrLCBleHRyYUluZm8pO1xuICAgIH0sIHRoaXMpO1xuXG4gICAgLy8gYnViYmxlIHBoYXNlXG4gICAgdGFyZ2V0cy5yZXZlcnNlKCkuc29tZSgoY3VycmVudFRhcmdldCkgPT4ge1xuICAgICAgaWYgKHByb3BhZ2F0aW9uU3RvcHBlZCkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIHZhciBleHRyYUluZm8gPSB7XG4gICAgICAgIGRlZmF1bHRQcmV2ZW50ZWQsXG4gICAgICAgIGV2ZW50UGhhc2U6IEJVQkJMSU5HX1BIQVNFLFxuICAgICAgICBwcm9wYWdhdGlvblN0b3BwZWQsXG4gICAgICAgIHRhcmdldDogdGhpcyxcbiAgICAgIH07XG4gICAgICBjdXJyZW50VGFyZ2V0Ll9fZW1pdChldmVudFR5cGUsIGRhdGEsIGNhbGxiYWNrLCBleHRyYUluZm8pO1xuICAgIH0sIHRoaXMpO1xuXG4gICAgaWYgKGRpZEVtaXRDYWxsYmFjaykge1xuICAgICAgdmFyIGV2ZW50ID0gTmF2aWdhdGlvbkV2ZW50LnBvb2woZXZlbnRUeXBlLCB0aGlzLCBkYXRhKTtcbiAgICAgIHByb3BhZ2F0aW9uU3RvcHBlZCAmJiBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgIGRlZmF1bHRQcmV2ZW50ZWQgJiYgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGRpZEVtaXRDYWxsYmFjay5jYWxsKHRoaXMsIGV2ZW50KTtcbiAgICAgIGV2ZW50LmRpc3Bvc2UoKTtcbiAgICB9XG5cbiAgICB0aGlzLl9lbWl0Q291bnRlci0tO1xuICAgIHdoaWxlICh0aGlzLl9lbWl0UXVldWUubGVuZ3RoKSB7XG4gICAgICB2YXIgYXJnczogYW55ID0gdGhpcy5fZW1pdFF1ZXVlLnNoaWZ0KCk7XG4gICAgICB0aGlzLmVtaXQuYXBwbHkodGhpcywgYXJncyk7XG4gICAgfVxuICB9XG5cbiAgZGlzcG9zZSgpOiB2b2lkIHtcbiAgICAvLyBjbGVhbiB1cCBldmVyeXRoaW5nLlxuICAgIHRoaXMuX2J1YmJsZUV2ZW50RW1pdHRlciAmJiB0aGlzLl9idWJibGVFdmVudEVtaXR0ZXIucmVtb3ZlQWxsTGlzdGVuZXJzKCk7XG4gICAgdGhpcy5fY2FwdHVyZUV2ZW50RW1pdHRlciAmJiB0aGlzLl9jYXB0dXJlRXZlbnRFbWl0dGVyLnJlbW92ZUFsbExpc3RlbmVycygpO1xuICAgIHRoaXMuX2J1YmJsZUV2ZW50RW1pdHRlciA9IG51bGw7XG4gICAgdGhpcy5fY2FwdHVyZUV2ZW50RW1pdHRlciA9IG51bGw7XG4gICAgdGhpcy5fY3VycmVudFJvdXRlID0gbnVsbDtcbiAgfVxuXG4gIC8vIFRoaXMgbWV0aG9kIGBfX21ldGhvZGAgaXMgcHJvdGVjdGVkLlxuICBfX2VtaXQoXG4gICAgZXZlbnRUeXBlOiBTdHJpbmcsXG4gICAgZGF0YTogYW55LFxuICAgIGRpZEVtaXRDYWxsYmFjazogP0Z1bmN0aW9uLFxuICAgIGV4dHJhSW5mbzogT2JqZWN0LFxuICApOiB2b2lkIHtcbiAgICB2YXIgZW1pdHRlcjtcbiAgICBzd2l0Y2ggKGV4dHJhSW5mby5ldmVudFBoYXNlKSB7XG4gICAgICBjYXNlIENBUFRVUklOR19QSEFTRTogLy8gcGhhc2UgPSAxXG4gICAgICAgIGVtaXR0ZXIgPSB0aGlzLl9jYXB0dXJlRXZlbnRFbWl0dGVyO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgQlVCQkxJTkdfUEhBU0U6IC8vIHBoYXNlID0gM1xuICAgICAgICBlbWl0dGVyID0gdGhpcy5fYnViYmxlRXZlbnRFbWl0dGVyO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGludmFyaWFudChmYWxzZSwgJ2ludmFsaWQgZXZlbnQgcGhhc2UgJXMnLCBleHRyYUluZm8uZXZlbnRQaGFzZSk7XG4gICAgfVxuXG4gICAgaWYgKGV4dHJhSW5mby50YXJnZXQgPT09IHRoaXMpIHtcbiAgICAgIC8vIHBoYXNlID0gMlxuICAgICAgZXh0cmFJbmZvLmV2ZW50UGhhc2UgPSBBVF9UQVJHRVQ7XG4gICAgfVxuXG4gICAgaWYgKGVtaXR0ZXIpIHtcbiAgICAgIGVtaXR0ZXIuZW1pdChcbiAgICAgICAgZXZlbnRUeXBlLFxuICAgICAgICBkYXRhLFxuICAgICAgICBkaWRFbWl0Q2FsbGJhY2ssXG4gICAgICAgIGV4dHJhSW5mb1xuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBfb25Gb2N1cyhldmVudDogTmF2aWdhdGlvbkV2ZW50KTogdm9pZCB7XG4gICAgaW52YXJpYW50KFxuICAgICAgZXZlbnQuZGF0YSAmJiBldmVudC5kYXRhLmhhc093blByb3BlcnR5KCdyb3V0ZScpLFxuICAgICAgJ2RpZGZvY3VzIGV2ZW50IHNob3VsZCBwcm92aWRlIHJvdXRlJ1xuICAgICk7XG4gICAgdGhpcy5fY3VycmVudFJvdXRlID0gZXZlbnQuZGF0YS5yb3V0ZTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE5hdmlnYXRpb25Db250ZXh0O1xuIl19